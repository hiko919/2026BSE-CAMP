<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- è¨­è¨ˆç³»çµ± --- */
        :root {
            --primary: #2AB7CA; 
            --primary-dark: #239cb0;
            --secondary: #76C95A; 
            --accent: #FF9F1C; 
            --bg: #F4F7F6;
            --text: #333;
            --card-bg: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* --- UI å…ƒä»¶ --- */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02);
            transition: 0.3s;
        }
        
        /* ç™»å…¥æ¨£å¼ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box { background: white; width: 100%; max-width: 320px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; }
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px; border-radius: 12px; font-size: 16px; font-weight: bold;
            width: 100%; cursor: pointer; margin-top: 10px;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }

        /* --- è¡Œç¨‹è¡¨å°ˆç”¨æ¨£å¼ --- */
        .day-tabs {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px;
            scrollbar-width: none;
        }
        .day-tabs::-webkit-scrollbar { display: none; }
        
        .day-tab {
            background: white; color: #888; padding: 8px 16px; border-radius: 20px;
            font-size: 14px; white-space: nowrap; border: 1px solid #eee;
            cursor: pointer; transition: 0.3s;
        }
        .day-tab.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(42, 183, 202, 0.3);
        }

        .schedule-item {
            display: flex; align-items: flex-start; gap: 15px;
            padding: 15px; border-radius: 12px; background: white;
            margin-bottom: 12px; position: relative; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        .schedule-item.past { background: #f0f0f0; color: #aaa; border: 1px solid #eee; }
        .schedule-item.past .time-badge { color: #aaa; background: #e0e0e0; }

        .schedule-item.active-now {
            background: #E0F7FA; border: 2px solid var(--primary);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(42, 183, 202, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(42, 183, 202, 0); }
            100% { box-shadow: 0 0 0 0 rgba(42, 183, 202, 0); }
        }
        .schedule-item.active-now::after {
            content: "é€²è¡Œä¸­"; position: absolute; top: 0; right: 0;
            background: var(--accent); color: white; font-size: 10px;
            padding: 3px 8px; border-bottom-left-radius: 8px;
        }

        .time-badge {
            background: rgba(42, 183, 202, 0.1); color: var(--primary);
            padding: 5px 8px; border-radius: 6px; font-weight: bold; font-size: 14px;
            min-width: 60px; text-align: center;
        }

        /* --- å¯¦é©—è¡¨æ ¼æ¨£å¼ (æ–°å¢) --- */
        .lab-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .lab-field { display: flex; flex-direction: column; }
        .lab-field label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .lab-field input, .lab-field textarea { 
            padding: 10px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; text-align: center;
            background: #FAFAFA; width: 100%;
        }
        .lab-field textarea { text-align: left; resize: none; }
        .lab-field input:focus, .lab-field textarea:focus { border-color: var(--primary); background: white; }
        .lab-unit { font-size: 10px; color: #aaa; text-align: right; margin-top: 2px; }

        /* --- è¨è«–å€æ¨£å¼ (æ–°å¢) --- */
        .topic-item { 
            border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 12px; 
            cursor: pointer; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: 0.2s; position: relative;
        }
        .topic-item:active { background-color: #f0f8ff; transform: scale(0.98); }
        
        .topic-meta {
            font-size: 12px; color: #888; margin-top: 8px; 
            display: flex; justify-content: space-between;
        }

        .new-topic-box { 
            background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; 
            border: 1px solid #eee; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .new-topic-box input, .new-topic-box textarea {
            width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px;
            font-size: 14px;
        }
        
        #discussion-section h2 { color: var(--primary); margin-top: 0; }
        #discussion-section p { line-height: 1.6; color: #555; }

        #comments-list { margin-bottom: 80px; padding-bottom: 20px;} 
        .comment-item {
            background: #f9f9f9; padding: 12px 15px; border-radius: 12px; margin-bottom: 10px;
            border-left: 4px solid var(--secondary);
        }

        .comment-input-area {
            position: fixed; bottom: 60px; left: 0; width: 100%;
            background: white; padding: 10px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #ddd; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 900;
        }
        .comment-user-badge {
            background: var(--primary); color: white; padding: 5px 10px; 
            border-radius: 15px; font-size: 12px; white-space: nowrap;
        }
        .comment-input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        
        .back-btn { background: none; border: none; font-size: 16px; color: #666; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }

        /* --- åº•éƒ¨å°èˆª --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item { text-align: center; font-size: 10px; color: #bbb; width: 20%; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* é é¢åˆ‡æ› */
        .page { display: none; opacity: 0; animation: fadeIn 0.3s forwards; }
        .page.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px; color: var(--primary);"><i class="fas fa-water"></i></div>
            <h2 style="color: var(--primary);">2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</h2>
            <p style="color: #888; font-size: 12px; margin-bottom: 20px;">è«‹è¼¸å…¥å ±åè³‡æ–™ç™»å…¥</p>
            <input type="text" id="loginName" class="login-input" placeholder="å§“å (ç‹å°æ˜)">
            <input type="password" id="loginID" class="login-input" placeholder="èº«åˆ†è­‰å­—è™Ÿ (A123...)">
            <button class="btn" onclick="handleLogin()">é–‹å§‹æ—…ç¨‹</button>
            <p id="loginMsg" style="color: red; font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container" style="display: none;">

        <div id="home" class="page active container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Hi, <span id="user-name">å­¸å“¡</span> ğŸ‘‹</h2>
                <div onclick="toggleDevMode()" style="background:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <i class="fas fa-clock" style="color:var(--primary);"></i>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, var(--primary), #4DD0E1); color: white;">
                <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; margin-bottom: 10px;">
                    <i class="fas fa-bullhorn"></i> ç¾åœ¨ç‹€æ…‹
                </div>
                <h3 id="home-status-title" style="margin: 0 0 5px 0; font-size: 24px;">ç›®å‰ç„¡æ´»å‹•</h3>
                <p id="home-status-time" style="margin: 0; opacity: 0.9;">--:--</p>
            </div>

            <div class="card">
                <h3 style="font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <i class="fas fa-id-card-alt" style="color: var(--accent);"></i> æˆ‘çš„è³‡è¨Š
                </h3>
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px;">
                        <div style="font-size: 12px; color: #888;">å°éšŠ</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--text);" id="info-group">--</div>
                    </div>
                    <div style="flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px;">
                        <div style="font-size: 12px; color: #888;">æˆ¿è™Ÿ</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="info-room">--</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-info-circle"></i> ç‡ŸéšŠå…¬å‘Š</h3>
                <p>æ­¡è¿ä¾†åˆ°å°å¤§ç”Ÿå·¥ç‡Ÿï¼è¨è«–å€åŠŸèƒ½å·²ä¸Šç·šï¼Œè«‹å¤šåŠ åˆ©ç”¨ã€‚</p>
            </div>
        </div>

        <div id="schedule" class="page container">
            <h2>ğŸ“… æ´»å‹•æ—¥ç¨‹</h2>
            <div class="day-tabs" id="day-tabs"></div>
            <div id="schedule-list"></div>
        </div>

        <div id="photos" class="page container">
            <h2>ğŸ“· ç›¸ç°¿</h2>
            <div class="card" style="text-align: center; padding: 40px;">
                <i class="fas fa-camera" style="font-size: 40px; color: #ddd; margin-bottom: 10px;"></i>
                <p style="color: #888;">ç›¸ç°¿åŠŸèƒ½å³å°‡ä¸Šç·š</p>
            </div>
        </div>

        <div id="activity" class="page container">
            <h2>ğŸ† æˆ°æ³æ’è¡Œæ¦œ</h2>
            <div class="card">
                <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;">æ•¸æ“šå³æ™‚æ›´æ–°</p>
                <div id="scoreboard"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="card" style="text-align: center; padding: 15px; margin-bottom: 0; cursor: pointer;" onclick="openSubPage('experiment-page')">
                    <i class="fas fa-flask" style="font-size: 30px; color: var(--primary); margin-bottom: 10px;"></i>
                    <h3 style="font-size: 14px;">å¯¦é©—ç´€éŒ„</h3>
                    <span style="font-size: 10px; color: #888;">å¡«å¯«æ•¸æ“š</span>
                </div>
                <div class="card" style="text-align: center; padding: 15px; margin-bottom: 0; cursor: pointer;" onclick="openSubPage('notes-page')">
                    <i class="fas fa-sticky-note" style="font-size: 30px; color: var(--accent); margin-bottom: 10px;"></i>
                    <h3 style="font-size: 14px;">æˆç™¼ç­†è¨˜</h3>
                    <span style="font-size: 10px; color: #888;">å°çµ„è¨è«–å€</span>
                </div>
            </div>
        </div>

        <div id="experiment-page" class="page container">
            <button class="back-btn" onclick="switchPage('activity', document.querySelector('.nav-item:nth-child(4)'))">
                <i class="fas fa-chevron-left"></i> è¿”å›åˆ—è¡¨
            </button>
            <h2 style="color: var(--primary);">âš—ï¸ æ°´è³ªæª¢æ¸¬ç´€éŒ„è¡¨</h2>
            <div class="card">
                <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;">
                    ç¬¬ <b id="exp-group-num">?</b> å°çµ„æ•¸æ“š (åŒæ­¥ä¸­)
                </p>
                
                <div class="lab-form">
                    <div class="lab-field">
                        <label>pH é…¸é¹¼å€¼</label>
                        <input type="number" id="lab-ph" step="0.1" placeholder="7.0">
                        <div class="lab-unit">ç„¡å–®ä½</div>
                    </div>
                    <div class="lab-field">
                        <label>æ°´æº« Temp.</label>
                        <input type="number" id="lab-temp" step="0.1" placeholder="25.0">
                        <div class="lab-unit">Â°C</div>
                    </div>
                    <div class="lab-field">
                        <label>å°é›»åº¦ EC</label>
                        <input type="number" id="lab-ec" placeholder="200">
                        <div class="lab-unit">Î¼S/cm</div>
                    </div>
                    <div class="lab-field">
                        <label>æ¿åº¦ Turbidity</label>
                        <input type="number" id="lab-tb" placeholder="5.0">
                        <div class="lab-unit">NTU</div>
                    </div>
                </div>

                <div class="lab-field" style="margin-top: 15px;">
                    <label>è§€å¯Ÿèˆ‡å‚™è¨»</label>
                    <textarea id="lab-note" style="height:80px;" placeholder="æ°´é«”é¡è‰²ã€æ°£å‘³ã€æ¡æ¨£åœ°é»..."></textarea>
                </div>

                <div style="font-size:10px; color:#888; text-align:right; margin: 10px 0;" id="exp-status">å°šæœªå„²å­˜</div>
                
                <button class="btn" onclick="saveLabData()" id="exp-btn">
                    <i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³æ•¸æ“š
                </button>
            </div>
        </div>

        <div id="notes-page" class="page container">
            
            <div id="topic-list-section">
                <button class="back-btn" onclick="switchPage('activity', document.querySelector('.nav-item:nth-child(4)'))">
                    <i class="fas fa-chevron-left"></i> è¿”å›é¸å–®
                </button>

                <h2 id="discussion-header">ğŸ“Œ æˆç™¼ç­†è¨˜è¨è«–å€</h2>
                
                <div class="new-topic-box">
                    <h4 style="margin-top:0; margin-bottom:10px;">ï¼‹ ç™¼èµ·æ–°è¨è«–</h4>
                    <p style="font-size:12px; color:#666; margin-bottom:5px;">ç™¼èµ·äººï¼š<span id="new-topic-author" style="font-weight:bold; color:var(--primary);"></span></p>
                    <input type="text" id="new-topic-title" placeholder="æ¨™é¡Œ (ä¾‹: å¯¦é©—çµæœæ€ªæ€ªçš„)">
                    <textarea id="new-topic-content" rows="3" placeholder="è«‹è©³ç´°æè¿°å•é¡Œ..."></textarea>
                    <button class="btn" id="btn-create-topic" style="margin-top:5px; font-size:14px;">ç™¼ä½ˆä¸»é¡Œ</button>
                </div>

                <hr style="border:0; border-top:1px solid #ddd; margin: 20px 0;">

                <div id="topics-container">
                    <p style="text-align:center; color:#999;">æ­£åœ¨è¼‰å…¥å°çµ„è¨è«–ä¸²...</p>
                </div>
            </div>

            <div id="discussion-section" style="display: none;">
                <button class="back-btn" id="btn-back-to-topics">
                    <i class="fas fa-arrow-left"></i> å›è¨è«–åˆ—è¡¨
                </button>
                
                <div class="card" id="current-topic-display">
                    <h2 id="view-topic-title" style="margin-bottom:10px;"></h2>
                    <p id="view-topic-content" style="white-space: pre-wrap; color:#333;"></p>
                    <div style="border-top:1px solid #eee; margin-top:10px; padding-top:10px; color:#888; font-size:12px;">
                        ç™¼èµ·äººï¼š<span id="view-topic-author" style="font-weight:bold;"></span>
                        <span style="float:right;" id="view-topic-time"></span>
                    </div>
                </div>

                <h3>ğŸ’¬ å°çµ„ç•™è¨€æ¿</h3>
                <div id="comments-list">
                    </div>

                <div class="comment-input-area">
                    <span class="comment-user-badge" id="comment-user-badge"></span>
                    <input type="text" id="my-comment" placeholder="è¼¸å…¥ç•™è¨€...">
                    <button id="btn-send-comment" style="background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="info" class="page container">
            <h2>â„¹ï¸ è³‡è¨Š</h2>
            <div class="card">
                <h3>ğŸ“ ç·Šæ€¥è¯çµ¡</h3>
                <button class="btn" onclick="window.location.href='tel:0912345678'"><i class="fas fa-phone"></i> æ’¥çµ¦ç¸½å¬</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('home', this)"><i class="fas fa-home nav-icon"></i>é¦–é </div>
        <div class="nav-item" onclick="switchPage('schedule', this)"><i class="fas fa-calendar-alt nav-icon"></i>è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchPage('photos', this)"><i class="fas fa-images nav-icon"></i>ç›¸ç°¿</div>
        <div class="nav-item" onclick="switchPage('activity', this)"><i class="fas fa-trophy nav-icon"></i>æ´»å‹•</div>
        <div class="nav-item" onclick="switchPage('info', this)"><i class="fas fa-info-circle nav-icon"></i>è³‡è¨Š</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, arrayUnion, onSnapshot, 
            collection, addDoc, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIrDF_HbcjgvafKfGRjF7VhB0pLpJO6W8",
            authDomain: "bse-camp.firebaseapp.com",
            projectId: "bse-camp",
            storageBucket: "bse-camp.firebasestorage.app",
            messagingSenderId: "287416151522",
            appId: "1:287416151522:web:435f09982f54943ba75dbb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let currentGroup = null;
        let currentTopicId = null; 
        let unsubscribeTopics = null;
        let unsubscribeComments = null;

        // --- è³‡æ–™åº« (å­¸å“¡åå–® - æ¸¬è©¦ç”¨) ---
        const campersDB = [
            { name: "ç‹å°æ˜", id: "A123456789", group: "1", room: "501" },
            { name: "é™³å°ç¾", id: "B223456789", group: "5", room: "502" },
            { name: "æ¸¬è©¦å“¡", id: "123", group: "8", room: "VIP" }
        ];

        // --- è¡Œç¨‹è³‡æ–™åº« (å®Œæ•´) ---
        const scheduleDB = [
            { day: "1/26", date: "2026-01-26", time: "12:30", title: "ç ´å†°", loc: "èˆŠé«”è‚²é¤¨" },
            { day: "1/26", date: "2026-01-26", time: "13:00", title: "é–‹ç‡Ÿ/æˆç™¼ä»‹ç´¹", loc: "åšé›… 101" },
            { day: "1/26", date: "2026-01-26", time: "14:00", title: "ç³»æ‰€ä»‹ç´¹", loc: "ç”Ÿå·¥ç³»é¤¨" },
            { day: "1/26", date: "2026-01-26", time: "15:00", title: "å¤§ç ´å†°", loc: "èˆŠé«”è‚²é¤¨" },
            { day: "1/26", date: "2026-01-26", time: "15:30", title: "å¤§åœ°éŠæˆ²", loc: "æ ¡åœ’å„è™•" },
            { day: "1/26", date: "2026-01-26", time: "17:30", title: "åƒæ™šé¤", loc: "é¤å»³" },
            { day: "1/26", date: "2026-01-26", time: "19:00", title: "å¯†å®¤é€ƒè„«", loc: "å…±åŒæ•™å®¤" },
            { day: "1/26", date: "2026-01-26", time: "21:30", title: "æ•´éšŠ/æ­æ·é‹", loc: "å…¬é¤¨ç«™" },
            { day: "1/26", date: "2026-01-26", time: "22:00", title: "åˆ°å¯“è¦‹é’æ—…", loc: "é’æ—…" },
            { day: "1/27", date: "2026-01-27", time: "06:30", title: "èµ·åºŠ", loc: "é’æ—…" },
            { day: "1/27", date: "2026-01-27", time: "07:30", title: "åƒæ—©é¤", loc: "é’æ—…" },
            { day: "1/27", date: "2026-01-27", time: "08:30", title: "æ­æ·é‹", loc: "æ·é‹ç«™" },
            { day: "1/27", date: "2026-01-27", time: "09:00", title: "æˆèª²+å¯¦é©—", loc: "ç”Ÿå·¥ç³»é¤¨" },
            { day: "1/27", date: "2026-01-27", time: "12:00", title: "åƒåˆé¤", loc: "æ ¡åœ’" },
            { day: "1/27", date: "2026-01-27", time: "13:30", title: "å·¥ä½œåŠ", loc: "åšé›…" },
            { day: "1/27", date: "2026-01-27", time: "17:30", title: "æ™šé¤", loc: "é¤å»³" },
            { day: "1/27", date: "2026-01-27", time: "18:30", title: "ç¶œè—å¤§è²å…¬", loc: "æ™šæœƒå ´åœ°" },
            { day: "1/27", date: "2026-01-27", time: "21:30", title: "æ•´éšŠ/æ­æ·é‹", loc: "å…¬é¤¨ç«™" },
            { day: "1/27", date: "2026-01-27", time: "22:00", title: "åˆ°å¯“è¦‹é’æ—…", loc: "é’æ—…" },
            { day: "1/28", date: "2026-01-28", time: "06:30", title: "èµ·åºŠ", loc: "é’æ—…" },
            { day: "1/28", date: "2026-01-28", time: "07:30", title: "åƒæ—©é¤", loc: "é’æ—…" },
            { day: "1/28", date: "2026-01-28", time: "08:30", title: "æ­æ·é‹", loc: "æ·é‹ç«™" },
            { day: "1/28", date: "2026-01-28", time: "09:00", title: "æˆèª²+å¯¦é©—", loc: "ç”Ÿå·¥ç³»é¤¨" },
            { day: "1/28", date: "2026-01-28", time: "12:00", title: "åƒåˆé¤", loc: "æ ¡åœ’" },
            { day: "1/28", date: "2026-01-28", time: "13:00", title: "æ­æ·é‹", loc: "å‰å¾€åƒè¨ªåœ°" },
            { day: "1/28", date: "2026-01-28", time: "14:00", title: "åƒè¨ª", loc: "æ ¡å¤–" },
            { day: "1/28", date: "2026-01-28", time: "17:00", title: "æ­æ·é‹", loc: "å›å…¬é¤¨" },
            { day: "1/28", date: "2026-01-28", time: "17:30", title: "åƒæ™šé¤", loc: "é¤å»³" },
            { day: "1/28", date: "2026-01-28", time: "18:30", title: "ç¶œè—å¤§è²å…¬", loc: "æ™šæœƒå ´åœ°" },
            { day: "1/28", date: "2026-01-28", time: "21:30", title: "æ•´éšŠ/æ­æ·é‹", loc: "å…¬é¤¨ç«™" },
            { day: "1/28", date: "2026-01-28", time: "22:00", title: "åˆ°å¯“è¦‹é’æ—…", loc: "é’æ—…" },
            { day: "1/29", date: "2026-01-29", time: "06:30", title: "èµ·åºŠ", loc: "é’æ—…" },
            { day: "1/29", date: "2026-01-29", time: "07:30", title: "åƒæ—©é¤", loc: "é’æ—…" },
            { day: "1/29", date: "2026-01-29", time: "08:30", title: "æ­æ·é‹", loc: "æ·é‹ç«™" },
            { day: "1/29", date: "2026-01-29", time: "09:00", title: "åƒè¨ª", loc: "æ ¡å¤–" },
            { day: "1/29", date: "2026-01-29", time: "12:00", title: "æ­æ·é‹", loc: "å›å…¬é¤¨" },
            { day: "1/29", date: "2026-01-29", time: "12:30", title: "åƒåˆé¤", loc: "æ ¡åœ’" },
            { day: "1/29", date: "2026-01-29", time: "13:30", title: "RPG", loc: "æ ¡åœ’å„è™•" },
            { day: "1/29", date: "2026-01-29", time: "17:30", title: "æ™šé¤", loc: "é¤å»³" },
            { day: "1/29", date: "2026-01-29", time: "18:30", title: "æ™šæœƒ", loc: "å¤§ç¦®å ‚" },
            { day: "1/29", date: "2026-01-29", time: "21:30", title: "æ•´éšŠ/æ­æ·é‹", loc: "å…¬é¤¨ç«™" },
            { day: "1/29", date: "2026-01-29", time: "22:00", title: "åˆ°å¯“è¦‹é’æ—…", loc: "é’æ—…" },
            { day: "1/30", date: "2026-01-30", time: "06:30", title: "èµ·åºŠ", loc: "é’æ—…" },
            { day: "1/30", date: "2026-01-30", time: "07:30", title: "åƒæ—©é¤", loc: "é’æ—…" },
            { day: "1/30", date: "2026-01-30", time: "08:30", title: "æ­æ·é‹", loc: "æ·é‹ç«™" },
            { day: "1/30", date: "2026-01-30", time: "09:00", title: "æˆç™¼", loc: "åšé›… 101" },
            { day: "1/30", date: "2026-01-30", time: "12:00", title: "After Party", loc: "ç§˜å¯†åŸºåœ°" }
        ];

        // --- æˆ°æ³è³‡æ–™ (8 çµ„) ---
        const teamScores = [
            { id: 1, score: 850 },
            { id: 2, score: 720 },
            { id: 3, score: 680 },
            { id: 4, score: 900 },
            { id: 5, score: 500 },
            { id: 6, score: 600 },
            { id: 7, score: 750 },
            { id: 8, score: 400 }
        ];

        let mockTime = null;
        let currentTabDay = "1/26";

        // ==========================================
        //  åŠŸèƒ½ A: ç™»å…¥ (åˆä½µç‰ˆ)
        // ==========================================
        window.handleLogin = async function() {
            try {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                const inputName = document.getElementById('loginName').value || "å­¸å“¡";
                const inputID = document.getElementById('loginID').value;
                const user = campersDB.find(c => c.name === inputName && c.id === inputID) || { name: inputName, group: "1", room: "?" };
                
                currentUser = user;
                currentGroup = user.group;

                // æ›´æ–°ç•«é¢è³‡è¨Š
                document.getElementById('user-name').innerText = user.name;
                document.getElementById('info-group').innerText = user.group;
                document.getElementById('info-room').innerText = user.room;

                // å¯¦é©— & è¨è«–å€è¨­å®š
                document.getElementById('new-topic-author').innerText = currentUser.name;
                document.getElementById('comment-user-badge').innerText = currentUser.name;
                document.getElementById('discussion-header').innerText = `ğŸ“Œ ç¬¬ ${currentGroup} å°çµ„æˆç™¼ç­†è¨˜`;
                
                // å•Ÿå‹•æ‰€æœ‰ç›£è½
                initSchedule();
                renderScoreboard();
                initGroupSync(currentGroup);
                initDiscussion(currentGroup); 
            } catch(e) {
                alert("ç™»å…¥éŒ¯èª¤: " + e.message);
            }
        };

        // ==========================================
        //  åŠŸèƒ½ B: è¡Œç¨‹è¡¨ & æˆ°æ³
        // ==========================================
        function initSchedule() {
            const today = mockTime ? new Date(mockTime) : new Date();
            const dateString = `${today.getMonth() + 1}/${today.getDate()}`;
            const validDays = ["1/26", "1/27", "1/28", "1/29", "1/30"];
            currentTabDay = validDays.includes(dateString) ? dateString : "1/26";

            renderTabs();
            renderList();
            updateLiveStatus();
            setInterval(updateLiveStatus, 60000);
        }

        function renderTabs() {
            const tabs = ["1/26", "1/27", "1/28", "1/29", "1/30"];
            const container = document.getElementById('day-tabs');
            container.innerHTML = tabs.map(day => `
                <div class="day-tab ${day === currentTabDay ? 'active' : ''}" 
                     onclick="switchTab('${day}')">
                     ${day}
                </div>
            `).join('');
        }

        window.switchTab = function(day) {
            currentTabDay = day;
            renderTabs();
            renderList();
        }

        function renderList() {
            const list = document.getElementById('schedule-list');
            const dayEvents = scheduleDB.filter(e => e.day === currentTabDay);
            const now = mockTime ? new Date(mockTime) : new Date();
            const nowTimeVal = now.getHours() * 60 + now.getMinutes();

            list.innerHTML = dayEvents.map(item => {
                let statusClass = "";
                const itemTimeParts = item.time.split(':');
                const itemTimeVal = parseInt(itemTimeParts[0]) * 60 + parseInt(itemTimeParts[1]);
                const isToday = (now.getMonth() + 1 + "/" + now.getDate()) === item.day;

                if (item.day < (now.getMonth()+1 + "/" + now.getDate())) {
                    statusClass = "past"; 
                } else if (isToday) {
                    if (nowTimeVal >= itemTimeVal && nowTimeVal < itemTimeVal + 60) {
                        statusClass = "active-now"; 
                    } else if (nowTimeVal > itemTimeVal) {
                        statusClass = "past";
                    }
                }

                return `
                    <div class="schedule-item ${statusClass}">
                        <div class="time-badge">${item.time}</div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:16px;">${item.title}</div>
                            <div style="font-size:13px; color:#888; margin-top:4px;">
                                <i class="fas fa-map-marker-alt"></i> ${item.loc}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderScoreboard() {
            const board = document.getElementById('scoreboard');
            const maxScore = Math.max(...teamScores.map(t => t.score), 100); 
            board.innerHTML = teamScores.map(team => `
                <div class="score-row" style="display:flex; align-items:center; margin-bottom:12px;">
                    <span style="width:50px; font-weight:bold; font-size:14px;">ç¬¬ ${team.id} å°</span>
                    <div style="flex:1; background:#eee; height:12px; border-radius:6px; margin:0 10px; overflow:hidden;">
                        <div style="width:${(team.score / maxScore) * 100}%; background:var(--secondary); height:100%; border-radius:6px; transition:width 1s;"></div>
                    </div>
                    <span style="width:40px; text-align:right; font-weight:bold; color:var(--secondary);">${team.score}</span>
                </div>
            `).join('');
        }

        function updateLiveStatus() {
            const now = mockTime ? new Date(mockTime) : new Date();
            const timeVal = now.getHours() * 60 + now.getMinutes();
            const dateStr = (now.getMonth()+1) + "/" + now.getDate();
            const todayEvents = scheduleDB.filter(e => e.day === dateStr);
            const currentEvent = todayEvents.find(e => {
                const t = parseInt(e.time.split(':')[0])*60 + parseInt(e.time.split(':')[1]);
                return timeVal >= t && timeVal < t + 60;
            });

            if (currentEvent) {
                document.getElementById('home-status-title').innerText = currentEvent.title;
                document.getElementById('home-status-time').innerText = `æ­£åœ¨é€²è¡Œ (${currentEvent.loc})`;
            } else {
                document.getElementById('home-status-title').innerText = "ç›®å‰ç„¡æ´»å‹•";
                document.getElementById('home-status-time').innerText = "ä¼‘æ¯ä¸­";
            }
            renderList();
        }

        window.toggleDevMode = function() {
            const input = prompt("ã€æ™‚å…‰æ©Ÿã€‘è¼¸å…¥æ¨¡æ“¬æ™‚é–“ (æ ¼å¼: 1/26 14:00)", "1/26 14:00");
            if(input) {
                const [d, t] = input.split(' ');
                mockTime = new Date(`2026/${d} ${t}:00`);
                initSchedule();
                renderScoreboard();
                alert(`æ™‚é–“å·²åˆ‡æ›è‡³ ${input}`);
            }
        }

        // ==========================================
        //  åŠŸèƒ½ C: å¯¦é©—åŒæ­¥ & ä¸Šå‚³
        // ==========================================
        function initGroupSync(groupId) {
            document.getElementById('exp-group-num').innerText = groupId;
            const docRef = doc(db, "groups", "group_" + groupId);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.labData) {
                        const ids = ['lab-ph', 'lab-temp', 'lab-ec', 'lab-tb', 'lab-note'];
                        ids.forEach(id => {
                            if(document.activeElement.id !== id) {
                                document.getElementById(id).value = data.labData[id] || "";
                            }
                        });
                        if(data.labLastEditor) {
                            const timeStr = data.labTime ? new Date(data.labTime).toLocaleTimeString() : "";
                            document.getElementById('exp-status').innerText = `æœ€å¾Œæ›´æ–°: ${data.labLastEditor} (${timeStr})`;
                        }
                    }
                }
            });
        }

        window.saveLabData = async function() {
            const btn = document.getElementById('exp-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
            
            const labData = {
                'lab-ph': document.getElementById('lab-ph').value,
                'lab-temp': document.getElementById('lab-temp').value,
                'lab-ec': document.getElementById('lab-ec').value,
                'lab-tb': document.getElementById('lab-tb').value,
                'lab-note': document.getElementById('lab-note').value
            };

            try {
                await setDoc(doc(db, "groups", "group_" + currentGroup), {
                    labData: labData,
                    labLastEditor: currentUser.name,
                    labTime: new Date().toISOString()
                }, { merge: true });
                
                btn.innerHTML = '<i class="fas fa-check"></i> ä¸Šå‚³æˆåŠŸ';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³æ•¸æ“š', 1500);
            } catch(e) {
                console.error(e);
                alert("ä¸Šå‚³å¤±æ•—");
                btn.innerHTML = '<i class="fas fa-redo"></i> é‡è©¦';
            }
        };

        // ==========================================
        //  åŠŸèƒ½ D: è¨è«–å€é‚è¼¯ (åˆ†çµ„)
        // ==========================================
        function initDiscussion(groupId) {
            if(unsubscribeTopics) unsubscribeTopics();
            const topicsRef = collection(db, "groups", "group_" + groupId, "topics");
            const qTopics = query(topicsRef, orderBy("createdAt", "desc"));

            unsubscribeTopics = onSnapshot(qTopics, (snapshot) => {
                const container = document.getElementById("topics-container");
                container.innerHTML = ""; 

                if (snapshot.empty) {
                    container.innerHTML = "<p style='text-align:center; color:#ccc; padding:20px;'>æœ¬å°çµ„é‚„æ²’æœ‰è¨è«–ï¼Œç”±ä½ ä¾†ç™¼èµ·ç¬¬ä¸€å€‹å§ï¼</p>";
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const div = document.createElement("div");
                    div.className = "topic-item";
                    
                    div.innerHTML = `
                        <h3 style="margin:0 0 5px 0; font-size:16px;">${data.title}</h3>
                        <p style="margin:0; font-size:13px; color:#666;">${data.content.substring(0, 40)}...</p>
                        <div class="topic-meta">
                            <span><i class="fas fa-user"></i> ${data.author}</span>
                            <span>æŸ¥çœ‹è©³æƒ… ></span>
                        </div>
                    `;
                    div.onclick = () => openDiscussion(doc.id, data);
                    container.appendChild(div);
                });
            });
        }

        function openDiscussion(docId, data) {
            currentTopicId = docId;
            document.getElementById("topic-list-section").style.display = "none";
            document.getElementById("discussion-section").style.display = "block";
            document.getElementById("view-topic-title").innerText = data.title;
            document.getElementById("view-topic-content").innerText = data.content;
            document.getElementById("view-topic-author").innerText = data.author;

            loadComments(docId);
        }

        function loadComments(topicId) {
            if (unsubscribeComments) unsubscribeComments();
            const commentsRef = collection(db, "groups", "group_" + currentGroup, "topics", topicId, "comments");
            const qComments = query(commentsRef, orderBy("createdAt", "asc"));

            unsubscribeComments = onSnapshot(qComments, (snapshot) => {
                const list = document.getElementById("comments-list");
                list.innerHTML = ""; 

                snapshot.forEach((doc) => {
                    const c = doc.data();
                    const div = document.createElement("div");
                    div.className = "comment-item";
                    div.innerHTML = `
                        <div style="font-size:12px; color:#888; margin-bottom:4px; font-weight:bold;">${c.user}</div>
                        <div style="color:#333;">${c.message}</div>
                    `;
                    list.appendChild(div);
                });
                window.scrollTo(0, document.body.scrollHeight);
            });
        }

        // æŒ‰éˆ•äº‹ä»¶ç¶å®š
        document.getElementById("btn-create-topic").onclick = async () => {
            const title = document.getElementById("new-topic-title").value;
            const content = document.getElementById("new-topic-content").value;
            if(!title || !content) return alert("è«‹è¼¸å…¥æ¨™é¡Œå’Œå…§å®¹");

            try {
                await addDoc(collection(db, "groups", "group_" + currentGroup, "topics"), {
                    title: title, content: content, author: currentUser.name, createdAt: serverTimestamp()
                });
                document.getElementById("new-topic-title").value = "";
                document.getElementById("new-topic-content").value = "";
            } catch(e) { console.error(e); alert("ç™¼ä½ˆå¤±æ•—"); }
        };

        document.getElementById("btn-send-comment").onclick = async () => {
            const msg = document.getElementById("my-comment").value;
            if(!msg) return;
            try {
                await addDoc(collection(db, "groups", "group_" + currentGroup, "topics", currentTopicId, "comments"), {
                    user: currentUser.name, message: msg, createdAt: serverTimestamp()
                });
                document.getElementById("my-comment").value = "";
            } catch(e) { console.error(e); alert("ç•™è¨€å¤±æ•—"); }
        };

        document.getElementById("btn-back-to-topics").onclick = () => {
            document.getElementById("discussion-section").style.display = "none";
            document.getElementById("topic-list-section").style.display = "block";
            currentTopicId = null;
            if (unsubscribeComments) unsubscribeComments(); 
        };

        // ==========================================
        //  åŠŸèƒ½ E: é é¢å°èˆª
        // ==========================================
        window.switchPage = function(pageId, navElement) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if(navElement) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                navElement.classList.add('active');
            }
            // é›¢é–‹è¨è«–å€æ™‚é‡ç½®
            if(pageId === 'notes-page') {
                document.getElementById("discussion-section").style.display = "none";
                document.getElementById("topic-list-section").style.display = "block";
            }
        }

        window.openSubPage = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            // è®“å°èˆªä¿æŒåœ¨ã€Œæ´»å‹•ã€
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.nav-item')[3].classList.add('active'); // ç¬¬å››å€‹æ˜¯æ´»å‹•
        }
    </script>
</body>
</html>
